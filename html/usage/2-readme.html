<!doctype html>
<html class="no-js" lang="es">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Índice" href="../genindex.html" /><link rel="search" title="Búsqueda" href="../search.html" /><link rel="next" title="KUBERNETES" href="3-readme.html" /><link rel="prev" title="DOCKER, KUBERNETES, OPENSHIFT, ISTIO" href="1-readme.html" />

    <meta name="generator" content="sphinx-4.2.0, furo 2021.10.09"/>
        <title>ISTIO - documentación de DOCKER, KUBERNETES, OPENSHIFT, ISTIO -</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=0254c309f5cadf746f1a613e7677379ac9c8cdcd" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=16fb25fabf47304eee183a5e9af80b1ba98259b1" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">documentación de DOCKER, KUBERNETES, OPENSHIFT, ISTIO - </div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">documentación de DOCKER, KUBERNETES, OPENSHIFT, ISTIO - </span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Búsqueda name="q" aria-label="Búsqueda">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="1-readme.html">DOCKER, KUBERNETES, OPENSHIFT, ISTIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="1-readme.html#docker">DOCKER</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">ISTIO</a></li>
<li class="toctree-l1"><a class="reference internal" href="3-readme.html">KUBERNETES</a></li>
<li class="toctree-l1"><a class="reference internal" href="4-readme.html">OPENSHIFT</a></li>
<li class="toctree-l1"><a class="reference internal" href="5-readme.html">Docker-compose y Docker Swarm</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="istio">
<h1>ISTIO<a class="headerlink" href="#istio" title="Enlazar permanentemente con este título">¶</a></h1>
<p><a class="reference external" href="https://istio.io/">Istio</a> es una plataforma de <a class="reference external" href="https://www.redhat.com/es/topics/microservices/what-is-a-service-mesh">red de
servicios</a>
con tecnología de open source, que permite controlar el intercambio de
datos entre los
<a class="reference external" href="https://www.redhat.com/es/topics/microservices/what-are-microservices">microservicios</a>.
Incluye
<a class="reference external" href="https://www.redhat.com/es/topics/api/what-are-application-programming-interfaces">API</a>
que le permiten
<a class="reference external" href="https://www.redhat.com/es/topics/integration/what-is-integration">integrarse</a>
a cualquier plataforma de registro, telemetría o sistema de políticas.
El diseño de esta plataforma facilita su ejecución en distintos
entornos: on-premise, alojados en la nube, en
<a class="reference external" href="https://www.redhat.com/es/topics/containers">contenedores</a> de
<a class="reference external" href="https://www.redhat.com/es/topics/containers/what-is-kubernetes">Kubernetes</a>
y en servicios que se ejecutan en <a class="reference external" href="https://www.redhat.com/es/topics/virtualization/what-is-a-virtual-machine">máquinas
virtuales</a>,
entre otros.</p>
<ul class="simple">
<li><p>Los Microservicios añaden complejidad en la red</p></li>
<li><p>Aparecen crosscutting concerns</p></li>
<li><p>Se implementan en código alejándonos de la lógica de negocio</p></li>
<li><p>Los Service Meshes solucionan el problema</p></li>
</ul>
<section id="instalacion">
<h2>INSTALACION<a class="headerlink" href="#instalacion" title="Enlazar permanentemente con este título">¶</a></h2>
<section id="arrancar-minikube">
<h3>Arrancar minikube<a class="headerlink" href="#arrancar-minikube" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">minikube</span> <span class="n">start</span> <span class="o">--</span><span class="n">cpus</span> <span class="mi">2</span> <span class="o">--</span><span class="n">memory</span> <span class="mi">8192</span>
</pre></div>
</div>
</section>
<section id="instalar-istio">
<h3>Instalar Istio<a class="headerlink" href="#instalar-istio" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">downloadIstio</span> <span class="o">|</span> <span class="n">sh</span> <span class="o">-</span>
<span class="n">cd</span> <span class="n">istio</span><span class="o">-</span><span class="mf">1.5.2</span><span class="o">/</span>
<span class="n">istioctl</span> <span class="n">manifest</span> <span class="n">apply</span> <span class="o">--</span><span class="nb">set</span> <span class="n">profile</span><span class="o">=</span><span class="n">demo</span>
<span class="n">kubectl</span> <span class="n">label</span> <span class="n">namespace</span> <span class="n">default</span> <span class="n">istio</span><span class="o">-</span><span class="n">injection</span><span class="o">=</span><span class="n">enabled</span>
</pre></div>
</div>
</section>
<section id="comprobar-instalacion">
<h3>Comprobar instalación<a class="headerlink" href="#comprobar-instalacion" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">namespaces</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">istio</span>
</pre></div>
</div>
</section>
</section>
<section id="tutorial">
<h2>TUTORIAL<a class="headerlink" href="#tutorial" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Desplegar nuestra aplicación basada en microservicios a Kubernetes
dentro de la service mesh. Además se explica cómo exponer un servicio.</p>
<section id="crear-namespace-tutorial">
<h3>Crear namespace tutorial<a class="headerlink" href="#crear-namespace-tutorial" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="n">namespace</span> <span class="n">tutorial</span>
</pre></div>
</div>
</section>
<section id="hacer-el-clone-del-proyecto">
<h3>Hacer el clone del proyecto<a class="headerlink" href="#hacer-el-clone-del-proyecto" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">jclmon</span><span class="o">/</span><span class="n">istio</span><span class="o">-</span><span class="n">tutorial</span>
<span class="n">cd</span> <span class="n">istio</span><span class="o">-</span><span class="n">tutorial</span><span class="o">/</span><span class="n">customer</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">springboot</span><span class="o">/</span>
</pre></div>
</div>
</section>
<section id="empaquetado-del-proyecto">
<h3>Empaquetado del proyecto<a class="headerlink" href="#empaquetado-del-proyecto" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">JAVA_TOOL_OPTIONS</span><span class="o">=</span><span class="s2">"-Dhttps.protocols=TLSv1.2"</span>
<span class="n">mvn</span> <span class="n">clean</span> <span class="n">package</span>
</pre></div>
</div>
</section>
<section id="asociar-a-istio-el-entorno-de-docker">
<h3>Asociar a istio el entorno de docker<a class="headerlink" href="#asociar-a-istio-el-entorno-de-docker" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>eval $(minikube -p istio docker-env)
</pre></div>
</div>
</section>
<section id="construccion-del-proyecto">
<h3>Construcción del proyecto<a class="headerlink" href="#construccion-del-proyecto" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">f</span> <span class="n">Dockerfile</span> <span class="o">-</span><span class="n">t</span> <span class="n">example</span><span class="o">/</span><span class="n">customer</span> <span class="o">.</span>
<span class="n">istioctl</span> <span class="n">kube</span><span class="o">-</span><span class="n">inject</span> <span class="o">-</span><span class="n">f</span> <span class="o">../../</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">Deployment</span><span class="o">.</span><span class="n">yml</span> <span class="o">|</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">n</span> <span class="n">tutorial</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span>
<span class="n">istioctl</span> <span class="n">kube</span><span class="o">-</span><span class="n">inject</span> <span class="o">-</span><span class="n">f</span> <span class="o">../../</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">Service</span><span class="o">.</span><span class="n">yml</span> <span class="o">|</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">n</span> <span class="n">tutorial</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span>

<span class="n">cd</span> <span class="o">../../../</span><span class="n">preference</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">springboot</span><span class="o">/</span>
<span class="n">mvn</span> <span class="n">clean</span> <span class="n">package</span>
<span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">f</span> <span class="n">Dockerfile</span> <span class="o">-</span><span class="n">t</span> <span class="n">example</span><span class="o">/</span><span class="n">preference</span><span class="p">:</span><span class="n">v1</span> <span class="o">.</span>
<span class="n">istioctl</span> <span class="n">kube</span><span class="o">-</span><span class="n">inject</span> <span class="o">-</span><span class="n">f</span> <span class="o">../../</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">Deployment</span><span class="o">.</span><span class="n">yml</span> <span class="o">|</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">n</span> <span class="n">tutorial</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span>
<span class="n">istioctl</span> <span class="n">kube</span><span class="o">-</span><span class="n">inject</span> <span class="o">-</span><span class="n">f</span> <span class="o">../../</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">Service</span><span class="o">.</span><span class="n">yml</span> <span class="o">|</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">n</span> <span class="n">tutorial</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span>

<span class="n">cd</span> <span class="o">../../../</span><span class="n">recommendation</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">vertx</span><span class="o">/</span>
<span class="n">mvn</span> <span class="n">clean</span> <span class="n">package</span>
<span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">f</span> <span class="n">Dockerfile</span> <span class="o">-</span><span class="n">t</span> <span class="n">example</span><span class="o">/</span><span class="n">recommendation</span><span class="p">:</span><span class="n">v1</span> <span class="o">.</span>
<span class="n">istioctl</span> <span class="n">kube</span><span class="o">-</span><span class="n">inject</span> <span class="o">-</span><span class="n">f</span> <span class="o">../../</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">Deployment</span><span class="o">.</span><span class="n">yml</span> <span class="o">|</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">n</span> <span class="n">tutorial</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span>
<span class="n">istioctl</span> <span class="n">kube</span><span class="o">-</span><span class="n">inject</span> <span class="o">-</span><span class="n">f</span> <span class="o">../../</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">Service</span><span class="o">.</span><span class="n">yml</span> <span class="o">|</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">n</span> <span class="n">tutorial</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span>

<span class="n">nano</span> <span class="o">.</span>\<span class="n">src</span>\<span class="n">main</span>\<span class="n">java</span>\<span class="n">com</span>\<span class="n">redhat</span>\<span class="n">developer</span>\<span class="n">demos</span>\<span class="n">recommendation</span>\<span class="n">RecommendationVerticle</span><span class="o">.</span><span class="n">java</span>
<span class="n">mvn</span> <span class="n">clean</span> <span class="n">package</span>
<span class="n">docker</span> <span class="n">build</span> <span class="o">-</span><span class="n">f</span> <span class="n">Dockerfile</span> <span class="o">-</span><span class="n">t</span> <span class="n">example</span><span class="o">/</span><span class="n">recommendation</span><span class="p">:</span><span class="n">v2</span> <span class="o">.</span>
<span class="n">istioctl</span> <span class="n">kube</span><span class="o">-</span><span class="n">inject</span> <span class="o">-</span><span class="n">f</span> <span class="o">../../</span><span class="n">kubernetes</span><span class="o">/</span><span class="n">Deployment</span><span class="o">-</span><span class="n">v2</span><span class="o">.</span><span class="n">yml</span> <span class="o">|</span> <span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">n</span> <span class="n">tutorial</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span>
</pre></div>
</div>
</section>
<section id="exponer-los-servicios-redireccion-de-puertos">
<h3>Exponer los servicios, redirección de puertos<a class="headerlink" href="#exponer-los-servicios-redireccion-de-puertos" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl port-forward $(kubectl get pod -n tutorial | grep "customer" | awk '{ print $1 }') -n tutorial 8080:8080
</pre></div>
</div>
<p>o también</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kubectl get pods -n tutorial
NAME                                 READY   STATUS    RESTARTS   AGE
customer-55c8cc5979-fnkg5            2/2     Running   1          22m
preference-v1-55b4d789d7-nldc6       2/2     Running   0          14m
recommendation-v1-8467dd859c-8696x   2/2     Running   0          13m
recommendation-v2-5b956bd67f-r9dvg   2/2     Running   0          5m31s
$ kubectl port-forward customer-55c8cc5979-fnkg5 8080:8080
</pre></div>
</div>
</section>
</section>
<section id="bluegreen-deployment">
<h2>BLUEGREEN DEPLOYMENT<a class="headerlink" href="#bluegreen-deployment" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Fichero Istio para despliegue de dos versiones como DestinationRule
destination-rule-recommendation-v1-v2.yml</p>
<p>Ahora lo que se requiere es que todo el tráfico se redirija a la versión
2</p>
<p>Para ello se crea el fichero:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">DestinationRule</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">recommendation</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
  <span class="n">subsets</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">labels</span><span class="p">:</span>
      <span class="n">version</span><span class="p">:</span> <span class="n">v1</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v1</span>
  <span class="o">-</span> <span class="n">labels</span><span class="p">:</span>
      <span class="n">version</span><span class="p">:</span> <span class="n">v2</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v2</span>
<span class="o">---</span>
</pre></div>
</div>
<p>Creación:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>istioctl create –f istiofiles/destination-rule-recom-v1-v2.yml –n tutorial
istioctl create –f istiofiles/virtual-service-recomendation-v2.yml
istioctl get virtualservices –n tutorial
isitioctl get destinationrules –n tutorial
</pre></div>
</div>
<p>Vemos que las invocaciones las redirige a la versión 2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl customer-tutorial.$(minishift ip).nip.io
</pre></div>
</div>
<p>Creamos la imagen</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">istio</span><span class="o">-</span><span class="n">tutorial</span><span class="o">/</span><span class="n">istiofiles</span><span class="o">/</span>
<span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="o">.</span>\<span class="n">destination</span><span class="o">-</span><span class="n">rule</span><span class="o">-</span><span class="n">recommendation</span><span class="o">-</span><span class="n">v1</span><span class="o">-</span><span class="n">v2</span><span class="o">.</span><span class="n">yml</span>
<span class="n">destinationrule</span><span class="o">.</span><span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">recommendation</span> <span class="n">created</span>
</pre></div>
</div>
<p>Compruebo que se han creado</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">destinationrules</span> <span class="o">-</span><span class="n">n</span> <span class="n">tutorial</span>
<span class="n">NAME</span>             <span class="n">HOST</span>             <span class="n">AGE</span>
<span class="n">recommendation</span>   <span class="n">recommendation</span>   <span class="mi">6</span><span class="n">s</span>
</pre></div>
</div>
<p>Para volver a la versión 1 creo virtual-service-recommendation-v1.yml:
Creo el fichero:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">VirtualService</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">recommendation</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">hosts</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">recommendation</span>
  <span class="n">http</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">route</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">destination</span><span class="p">:</span>
        <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
        <span class="n">subset</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v1</span>
      <span class="n">weight</span><span class="p">:</span> <span class="mi">100</span>
<span class="o">---</span>
</pre></div>
</div>
<p>Reemplazo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>isitioctl replace –f istiofiles/virtual-service-recommendation-v1.yml -n tutorial
</pre></div>
</div>
</section>
<section id="canary-release">
<h2>CANARY RELEASE<a class="headerlink" href="#canary-release" title="Enlazar permanentemente con este título">¶</a></h2>
<p>No manda el 100% del tráfico a una versión o a otra, el cambio se va
haciendo incrementalmente desde la versión 1 a la versión 2 Creo el
fichero para un 50 - 50</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">VirtualService</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">recommendation</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">hosts</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">recommendation</span>
  <span class="n">http</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">route</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">destination</span><span class="p">:</span>
        <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
        <span class="n">subset</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v1</span>
      <span class="n">weight</span><span class="p">:</span> <span class="mi">50</span>
    <span class="o">-</span> <span class="n">destination</span><span class="p">:</span>
        <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
        <span class="n">subset</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v2</span>
      <span class="n">weight</span><span class="p">:</span> <span class="mi">50</span>
<span class="o">---</span>
</pre></div>
</div>
<p>Creamos la imagen:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>istioctl create –f istiofiles/virtual-service-recommendation-v1_and_v2_50_50.yml
istioctl get virtualservices –n tutorial
</pre></div>
</div>
</section>
<section id="control-de-trafico-por-contenido">
<h2>CONTROL DE TRAFICO POR CONTENIDO<a class="headerlink" href="#control-de-trafico-por-contenido" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Redirecciona el tráfico según el contenido de los paquetes y no por
porcentaje. El contenido estará contenido en el header de HTTP En el
ejemplo user agent que identifica al navegador para safari pasa por la
versión 2. Creo el fichero:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">VirtualService</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">recommendation</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">hosts</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">recommendation</span>
  <span class="n">http</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">match</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">headers</span><span class="p">:</span>
        <span class="n">baggage</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">agent</span><span class="p">:</span>
          <span class="n">regex</span><span class="p">:</span> <span class="o">.*</span><span class="n">Safari</span><span class="o">.*</span>
    <span class="n">route</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">destination</span><span class="p">:</span>
        <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
        <span class="n">subset</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v2</span>
  <span class="o">-</span> <span class="n">route</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">destination</span><span class="p">:</span>
        <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
        <span class="n">subset</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v1</span>
<span class="o">---</span>
</pre></div>
</div>
<p>Creamos la imagen:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>istioctl replace –f istiofiles/virtual-service-safari-recommendation-v2.yml
curl -A Safari customer-tutorial.$(minishift ip).nip.io
curl -A Firefox customer-tutorial.$(minishift ip).nip.io
</pre></div>
</div>
</section>
<section id="dark-launchers-shadowing-trafic-mirroring-trafic">
<h2>DARK LAUNCHERS SHADOWING TRAFIC MIRRORING TRAFIC<a class="headerlink" href="#dark-launchers-shadowing-trafic-mirroring-trafic" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Se podría monitorizar para que la respuesta la de la versión 1 pero
también las peticiones se envíen a la versión 2 con el fin de probar
cual es su respuesta. Al cliente se le envía la respuesta de la versión
1. Se ejecutarán las dos versiones las dos recibirán las request.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">DestinationRule</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">recommendation</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
  <span class="n">subsets</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">labels</span><span class="p">:</span>
      <span class="n">version</span><span class="p">:</span> <span class="n">v1</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v1</span>
  <span class="o">-</span> <span class="n">labels</span><span class="p">:</span>
      <span class="n">version</span><span class="p">:</span> <span class="n">v2</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v2</span>
<span class="o">---</span>
</pre></div>
</div>
<p>Creamos la imagen:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl create -f .\destination-rule-recommendation-v1-v2.yml
kubectl get destinationrules -n tutorial
NAME             HOST             AGE
recommendation   recommendation   3m21s
kubectl describe destinationrules recommendation -n tutorial
…
  Subsets:
    Labels:
      Version:  v1
    Name:       version-v1
    Labels:
      Version:  v2
    Name:       version-v2
Events:         &lt;none&gt;
</pre></div>
</div>
<section id="ver-los-logs">
<h3>Ver los logs<a class="headerlink" href="#ver-los-logs" title="Enlazar permanentemente con este título">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl logs -f `kubectl get pods | grep recommmendation-v2 | awk '{print $1}'` -c recommendation
</pre></div>
</div>
</section>
</section>
<section id="egress">
<h2>EGRESS<a class="headerlink" href="#egress" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Acceso a servicios externos al cluster, se crean reglas egress que
configura que tráfico permitimos para salida de istio. Por ejemplo
usamos este servicio que nos proporciona la hora:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">worldclockapi</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">json</span><span class="o">/</span><span class="n">cet</span><span class="o">/</span><span class="n">now</span>
</pre></div>
</div>
<p>Creación de un service entry con egress:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">ServiceEntry</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">worldclockapi</span><span class="o">-</span><span class="n">egress</span><span class="o">-</span><span class="n">rule</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">hosts</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">worldclockapi</span><span class="o">.</span><span class="n">com</span>
  <span class="n">ports</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">http</span><span class="o">-</span><span class="mi">80</span>
    <span class="n">number</span><span class="p">:</span> <span class="mi">80</span>
    <span class="n">protocol</span><span class="p">:</span> <span class="n">http</span>
</pre></div>
</div>
<p>Creamos la imagen:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="o">.</span>\<span class="n">service</span><span class="o">-</span><span class="n">entry</span><span class="o">-</span><span class="n">egress</span><span class="o">-</span><span class="n">worldclockapi</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
</section>
<section id="servicios-resilentes">
<h2>SERVICIOS RESILENTES<a class="headerlink" href="#servicios-resilentes" title="Enlazar permanentemente con este título">¶</a></h2>
<ul class="simple">
<li><p>Circuit breaker, estados del servicio circuit breaker (Closed, Open,
Half Open)</p></li>
<li><p>El reset timeout es el tiempo que tenemos para revisar de nuevo la
conexión.</p></li>
<li><p>Cuando el circuito está abierto podemos responder con un valor
determinado.</p></li>
<li><p>Istio implementa circuit breaker y retry para los reintentos.</p></li>
</ul>
</section>
<section id="load-balancing">
<h2>LOAD BALANCING<a class="headerlink" href="#load-balancing" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Empezamos desde cero:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">get</span> <span class="n">virtualservice</span> <span class="o">-</span><span class="n">n</span> <span class="n">tutorial</span>
<span class="n">No</span> <span class="n">resources</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">tutorial</span> <span class="n">namespace</span><span class="o">.</span>
<span class="n">kubectl</span> <span class="n">get</span> <span class="n">destinationrule</span> <span class="o">-</span><span class="n">n</span> <span class="n">tutorial</span>
<span class="n">No</span> <span class="n">resources</span> <span class="n">found</span> <span class="ow">in</span> <span class="n">tutorial</span> <span class="n">namespace</span><span class="o">.</span>
</pre></div>
</div>
<p>Creamos el destination rule y el balanceo 50 - 50</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="o">.</span>\<span class="n">destination</span><span class="o">-</span><span class="n">rule</span><span class="o">-</span><span class="n">recommendation</span><span class="o">-</span><span class="n">v1</span><span class="o">-</span><span class="n">v2</span><span class="o">.</span><span class="n">yml</span>
<span class="n">destinationrule</span><span class="o">.</span><span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">recommendation</span> <span class="n">created</span>
<span class="n">kubectl</span> <span class="n">apply</span> <span class="o">-</span><span class="n">f</span> <span class="o">.</span>\<span class="n">virtual</span><span class="o">-</span><span class="n">service</span><span class="o">-</span><span class="n">recommendation</span><span class="o">-</span><span class="n">v1_and_v2_50_50</span><span class="o">.</span><span class="n">yml</span>
<span class="n">virtualservice</span><span class="o">.</span><span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">recommendation</span> <span class="n">created</span>
</pre></div>
</div>
</section>
<section id="timeout">
<h2>TIMEOUT<a class="headerlink" href="#timeout" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Cuando las llamadas sufren retraso en una de las versiones se puede
balancear a otra. Incluyo un timer en:
.:raw-latex:<cite>src</cite>.java
para emular retraso Para emular un retraso de la v2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mvn clean install
docker build -f Dockerfile -t example/recommendation:v2 .
// borro el pod para que kubernetes lo recree
kubectl delete pod –l app=recommendation, versión=v2
</pre></div>
</div>
<p>Si accedemos a la versión 2 se visualiza que el tiempo de respuesta es
mucho más lento. Lo que no quiere el servicio 2 es tener más request.</p>
<p>Emulo las llamadas</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>siege –r 2 –c 20 –v customer-tutorial.$(minishift ip).nip.io
</pre></div>
</div>
</section>
<section id="circuit-breaker">
<h2>CIRCUIT BREAKER<a class="headerlink" href="#circuit-breaker" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Este patrón que implementa por ejemplo Hystrix por código, Istio ya lo
tiene implementado. Cuantos errores consecutivos deben pasar para que se
abra el circuito, cual es la duración mínima que un host podrá estar
expulsado para poder ser elegible para el envío de tráfico. Según al
ejemplo del apartado anterior configuramos para que no se de la misma
carga a la versión 2.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">DestinationRule</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">creationTimestamp</span><span class="p">:</span> <span class="n">null</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">recommendation</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">tutorial</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
  <span class="n">subsets</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v1</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">v1</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v2</span>
      <span class="n">labels</span><span class="p">:</span>
        <span class="n">version</span><span class="p">:</span> <span class="n">v2</span>
      <span class="n">trafficPolicy</span><span class="p">:</span>
        <span class="n">connectionPool</span><span class="p">:</span>
          <span class="n">http</span><span class="p">:</span>
            <span class="n">http1MaxPendingRequests</span><span class="p">:</span> <span class="mi">1</span>
            <span class="n">maxRequestsPerConnection</span><span class="p">:</span> <span class="mi">1</span>
          <span class="n">tcp</span><span class="p">:</span>
            <span class="n">maxConnections</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">outlierDetection</span><span class="p">:</span>
          <span class="n">baseEjectionTime</span><span class="p">:</span> <span class="mf">120.000</span><span class="n">s</span>
          <span class="n">consecutiveErrors</span><span class="p">:</span> <span class="mi">1</span>
          <span class="n">interval</span><span class="p">:</span> <span class="mf">1.000</span><span class="n">s</span>
          <span class="n">maxEjectionPercent</span><span class="p">:</span> <span class="mi">100</span>
</pre></div>
</div>
<p>Reemplazo el destination rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>istioctl replace –f istiofiles/destination-rules-cb_policy_version_v2.yml
</pre></div>
</div>
</section>
<section id="pool-ejection">
<h2>POOL EJECTION<a class="headerlink" href="#pool-ejection" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Si uno de los pods del pool comienza a devolver errores valores 500 de
HTTP Reescalamos el pool de recursos de la versión 2</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kubectl scale deployment recommendation-v2 –replicas=2 –n tutorial
kubectl get pods –l app=recommendation,versión=v2
</pre></div>
</div>
<p>Fichero destination-rule-crecommendation_cb_policy_pool_ejection.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">destination</span><span class="o">-</span><span class="n">rule</span><span class="o">-</span><span class="n">recommendation_cb_policy_pool_ejection</span><span class="o">.</span><span class="n">yml</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">DestinationRule</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">creationTimestamp</span><span class="p">:</span> <span class="n">null</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">recommendation</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">tutorial</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
  <span class="n">subsets</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">labels</span><span class="p">:</span>
      <span class="n">version</span><span class="p">:</span> <span class="n">v1</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v1</span>
    <span class="n">trafficPolicy</span><span class="p">:</span>
      <span class="n">connectionPool</span><span class="p">:</span>
        <span class="n">http</span><span class="p">:</span> <span class="p">{}</span>
        <span class="n">tcp</span><span class="p">:</span> <span class="p">{}</span>
      <span class="n">loadBalancer</span><span class="p">:</span>
        <span class="n">simple</span><span class="p">:</span> <span class="n">RANDOM</span>
      <span class="n">outlierDetection</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">con</span> <span class="n">un</span> <span class="n">error</span> <span class="n">hace</span> <span class="n">ejection</span> <span class="n">solo</span> <span class="n">realizara</span> <span class="n">una</span> <span class="n">petición</span> <span class="n">y</span> <span class="n">esperara</span>
        <span class="o">//</span> <span class="mi">15</span> <span class="n">segundos</span> <span class="n">para</span> <span class="n">hacer</span> <span class="n">la</span> <span class="n">siguiente</span>
        <span class="n">baseEjectionTime</span><span class="p">:</span> <span class="mf">15.000</span><span class="n">s</span>
        <span class="n">consecutiveErrors</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">interval</span><span class="p">:</span> <span class="mf">5.000</span><span class="n">s</span>
        <span class="n">maxEjectionPercent</span><span class="p">:</span> <span class="mi">100</span>
  <span class="o">-</span> <span class="n">labels</span><span class="p">:</span>
      <span class="n">version</span><span class="p">:</span> <span class="n">v2</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">version</span><span class="o">-</span><span class="n">v2</span>
    <span class="n">trafficPolicy</span><span class="p">:</span>
      <span class="n">connectionPool</span><span class="p">:</span>
        <span class="n">http</span><span class="p">:</span> <span class="p">{}</span>
        <span class="n">tcp</span><span class="p">:</span> <span class="p">{}</span>
      <span class="n">loadBalancer</span><span class="p">:</span>
        <span class="n">simple</span><span class="p">:</span> <span class="n">RANDOM</span>
      <span class="n">outlierDetection</span><span class="p">:</span>
        <span class="n">baseEjectionTime</span><span class="p">:</span> <span class="mf">15.000</span><span class="n">s</span>
        <span class="n">consecutiveErrors</span><span class="p">:</span> <span class="mi">1</span>
        <span class="n">interval</span><span class="p">:</span> <span class="mf">5.000</span><span class="n">s</span>
        <span class="n">maxEjectionPercent</span><span class="p">:</span> <span class="mi">100</span>
</pre></div>
</div>
<p>Reemplazo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>istioctl replace –f istiofiles/destination-rule-crecommendation_cb_policy_pool_ejection.yml
</pre></div>
</div>
</section>
<section id="solucion-final">
<h2>SOLUCION FINAL<a class="headerlink" href="#solucion-final" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Con la solución anterior al menos uno de los usuarios recibirá un error,
el siguiente error se dará a los 15s. Con esta solución no se devuelve
error al usuario. Ahora se hace retry automático por cada error para que
se resuelva la petición desde otro pod. Se configura para 3 reintentos:
Fichero: virtual-service-recommendation-v2_retry.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">VirtualService</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">recommendation</span>
  <span class="n">namespace</span><span class="p">:</span> <span class="n">tutorial</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">hosts</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">recommendation</span>
  <span class="n">http</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">route</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">destination</span><span class="p">:</span>
        <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
    <span class="n">retries</span><span class="p">:</span>
      <span class="n">attempts</span><span class="p">:</span> <span class="mi">3</span>
      <span class="n">perTryTimeout</span><span class="p">:</span> <span class="mi">2</span><span class="n">s</span>
</pre></div>
</div>
</section>
<section id="testing">
<h2>TESTING<a class="headerlink" href="#testing" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Pruebas sobre el mesh.</p>
<section id="testing-caotico">
<h3>TESTING CAOTICO<a class="headerlink" href="#testing-caotico" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Inyectamos errores en las invocaciones para ver la respuesta del service
mesh. El 50% de los request a recommedation devolverán error 503 Se
utiliza label de kubernetess, fichero
virtual-service-recommendation-503.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">VirtualService</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">recommendation</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">hosts</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">recommendation</span>
  <span class="n">http</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">fault</span><span class="p">:</span>
      <span class="n">abort</span><span class="p">:</span>
        <span class="n">httpStatus</span><span class="p">:</span> <span class="mi">503</span>
        <span class="n">percent</span><span class="p">:</span> <span class="mi">50</span>
    <span class="n">route</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">destination</span><span class="p">:</span>
        <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
        <span class="n">subset</span><span class="p">:</span> <span class="n">app</span><span class="o">-</span><span class="n">recommendation</span>
<span class="o">---</span>
</pre></div>
</div>
<p>Creamos la imagen:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>istioctl create –f istiofiles/virtual-service-recommendation-503.yml
</pre></div>
</div>
</section>
<section id="retrasos">
<h3>RETRASOS<a class="headerlink" href="#retrasos" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Inyecta retrasos, añade delays a las llamadas de servicios para ver cómo
se comportan los consumidores. Añade un sleep de 7 segundos al 50 por
ciento de las llamadas. Fichero virtual-service-recommendation-delay.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="n">networking</span><span class="o">.</span><span class="n">istio</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">v1alpha3</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">VirtualService</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">recommendation</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">hosts</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">recommendation</span>
  <span class="n">http</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">fault</span><span class="p">:</span>
      <span class="n">delay</span><span class="p">:</span>
        <span class="n">fixedDelay</span><span class="p">:</span> <span class="mf">7.000</span><span class="n">s</span>
        <span class="n">percent</span><span class="p">:</span> <span class="mi">50</span>
    <span class="n">route</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">destination</span><span class="p">:</span>
        <span class="n">host</span><span class="p">:</span> <span class="n">recommendation</span>
        <span class="n">subset</span><span class="p">:</span> <span class="n">app</span><span class="o">-</span><span class="n">recommendation</span>
<span class="o">---</span>
</pre></div>
</div>
</section>
</section>
<section id="trazabilidad">
<h2>TRAZABILIDAD<a class="headerlink" href="#trazabilidad" title="Enlazar permanentemente con este título">¶</a></h2>
<p>Observabilidad outofthebox de Istio, Jaeger ui permite revisar la
trazabilidad, Comunicaciones entre servicios y trazabilidad</p>
<section id="metricas">
<h3>MÉTRICAS<a class="headerlink" href="#metricas" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Métricas outofthebox de Istio, Prometheus es un sistema para la
visualización de métricas OpenSource que además de guardar datos tiene
un sistema de alertas para notificar datos. Utiliza Graphana como Data
Visualizer, además tiene la consola de prometheus.</p>
</section>
<section id="kiali">
<h3>KIALI<a class="headerlink" href="#kiali" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Que están haciendo los servicios en el service mesh, sirve para
visualizar gráficamente las comunicaciones entre servicios y como están
configurados. Instalación:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="n">apply</span> <span class="n">kiali</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
</section>
</section>
<section id="seguridad">
<h2>SEGURIDAD<a class="headerlink" href="#seguridad" title="Enlazar permanentemente con este título">¶</a></h2>
<section id="white-lists">
<h3>WHITE LISTS<a class="headerlink" href="#white-lists" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Reglas para la comunicación entre los servicios, evita comunicaciones no
esperadas. Con esto evitamos comprometer los servicios.
Preferenceservice solo aceptará comunicaciones de recommendation service
Fichero acl-whitelist.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="s2">"config.istio.io/v1alpha2"</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">listchecker</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">preferencewhitelist</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">overrides</span><span class="p">:</span> <span class="p">[</span><span class="s2">"recommendation"</span><span class="p">]</span>
  <span class="n">blacklist</span><span class="p">:</span> <span class="n">false</span>
<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="s2">"config.istio.io/v1alpha2"</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">listentry</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">preferencesource</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">value</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s2">"app"</span><span class="p">]</span>
<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="s2">"config.istio.io/v1alpha2"</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">rule</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">checkfromcustomer</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">match</span><span class="p">:</span> <span class="n">destination</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s2">"app"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"preference"</span>
  <span class="n">actions</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">handler</span><span class="p">:</span> <span class="n">preferencewhitelist</span><span class="o">.</span><span class="n">listchecker</span>
    <span class="n">instances</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">preferencesource</span><span class="o">.</span><span class="n">listentry</span>
</pre></div>
</div>
</section>
<section id="black-lists">
<h3>BLACK LISTS<a class="headerlink" href="#black-lists" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Se indicarán cuáles son las comunicaciones que no están permitidas. Para
hacer la prueba vamos a denegar la comunicación entre customers y
preferences. Denegaremos la comunicación e indicamos como informar al
usuario. Fichero acl-blacklist.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="s2">"config.istio.io/v1alpha2"</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">denier</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">denycustomerhandler</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">status</span><span class="p">:</span>
    <span class="n">code</span><span class="p">:</span> <span class="mi">7</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">Not</span> <span class="n">allowed</span>
<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="s2">"config.istio.io/v1alpha2"</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">checknothing</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">denycustomerrequests</span>
<span class="n">spec</span><span class="p">:</span>
<span class="o">---</span>
<span class="n">apiVersion</span><span class="p">:</span> <span class="s2">"config.istio.io/v1alpha2"</span>
<span class="n">kind</span><span class="p">:</span> <span class="n">rule</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="n">denycustomer</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">match</span><span class="p">:</span> <span class="n">destination</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s2">"app"</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"preference"</span> <span class="o">&amp;&amp;</span> <span class="n">source</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="s2">"app"</span><span class="p">]</span><span class="o">==</span><span class="s2">"customer"</span>
  <span class="n">actions</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">handler</span><span class="p">:</span> <span class="n">denycustomerhandler</span><span class="o">.</span><span class="n">denier</span>
    <span class="n">instances</span><span class="p">:</span> <span class="p">[</span> <span class="n">denycustomerrequests</span><span class="o">.</span><span class="n">checknothing</span> <span class="p">]</span>
</pre></div>
</div>
</section>
<section id="mutual-tls">
<h3>MUTUAL TLS<a class="headerlink" href="#mutual-tls" title="Enlazar permanentemente con este título">¶</a></h3>
<p>Con Istio la comunicación entre los proxy de cada uno de los servicios
será con HTTPS y nuestros servicios puedan seguir tratando HTTP. Con
esto se evita crear e instalar certificados.</p>
<p>Fichero authentication-enable-tls.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="s2">"authentication.istio.io/v1alpha1"</span>
<span class="n">kind</span><span class="p">:</span> <span class="s2">"Policy"</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="s2">"default"</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">peers</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">mtls</span><span class="p">:</span> <span class="p">{}</span>
</pre></div>
</div>
<p>Fichero destination-rule-tls.yml</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apiVersion</span><span class="p">:</span> <span class="s2">"networking.istio.io/v1alpha3"</span>
<span class="n">kind</span><span class="p">:</span> <span class="s2">"DestinationRule"</span>
<span class="n">metadata</span><span class="p">:</span>
  <span class="n">name</span><span class="p">:</span> <span class="s2">"default"</span>
<span class="n">spec</span><span class="p">:</span>
  <span class="n">host</span><span class="p">:</span> <span class="s2">"*.tutorial.svc.cluster.local"</span>
  <span class="n">trafficPolicy</span><span class="p">:</span>
    <span class="n">tls</span><span class="p">:</span>
      <span class="n">mode</span><span class="p">:</span> <span class="n">ISTIO_MUTUAL</span>
</pre></div>
</div>
<p>Aplicamos:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>curl http://${GATEWAY_URL}
istioctl apply –f istiofiles/authentication-enable-tls.yml
istioctl apply –f istiofiles/destination-rule-tls.yml
istioctl authn tls-check | grep tutorial
</pre></div>
</div>
<p>Podríamos hacer sniffer del tráfico entre servicios para revisarlo.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Kubectl exec –it $CUSTOMER_POD –c istio-proxy /bin/bash
Ifonfig para ver la ip 172.17.0.11 y desde la máquina
sudo tcpdump –vvvv –A –i eth0 ‘((dst port 8080) and (net 172.17.0.11))’
</pre></div>
</div>
<p>Deshabilitamos:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>istioctl delete –f istiofiles/authentication-enable-tls.yml
istioctl delete –f istiofiles/destination-rule-tls.yml
</pre></div>
</div>
<p>Y si hacemos lo mismo, la información aparece…</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="3-readme.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">KUBERNETES</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="1-readme.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">DOCKER, KUBERNETES, OPENSHIFT, ISTIO</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2021, jclmon |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>. |
            <a class="muted-link" href="../_sources/usage/2-readme.rst.txt"
               rel="nofollow">
              Mostrar el código
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contenidos
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">ISTIO</a><ul>
<li><a class="reference internal" href="#instalacion">INSTALACION</a><ul>
<li><a class="reference internal" href="#arrancar-minikube">Arrancar minikube</a></li>
<li><a class="reference internal" href="#instalar-istio">Instalar Istio</a></li>
<li><a class="reference internal" href="#comprobar-instalacion">Comprobar instalación</a></li>
</ul>
</li>
<li><a class="reference internal" href="#tutorial">TUTORIAL</a><ul>
<li><a class="reference internal" href="#crear-namespace-tutorial">Crear namespace tutorial</a></li>
<li><a class="reference internal" href="#hacer-el-clone-del-proyecto">Hacer el clone del proyecto</a></li>
<li><a class="reference internal" href="#empaquetado-del-proyecto">Empaquetado del proyecto</a></li>
<li><a class="reference internal" href="#asociar-a-istio-el-entorno-de-docker">Asociar a istio el entorno de docker</a></li>
<li><a class="reference internal" href="#construccion-del-proyecto">Construcción del proyecto</a></li>
<li><a class="reference internal" href="#exponer-los-servicios-redireccion-de-puertos">Exponer los servicios, redirección de puertos</a></li>
</ul>
</li>
<li><a class="reference internal" href="#bluegreen-deployment">BLUEGREEN DEPLOYMENT</a></li>
<li><a class="reference internal" href="#canary-release">CANARY RELEASE</a></li>
<li><a class="reference internal" href="#control-de-trafico-por-contenido">CONTROL DE TRAFICO POR CONTENIDO</a></li>
<li><a class="reference internal" href="#dark-launchers-shadowing-trafic-mirroring-trafic">DARK LAUNCHERS SHADOWING TRAFIC MIRRORING TRAFIC</a><ul>
<li><a class="reference internal" href="#ver-los-logs">Ver los logs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#egress">EGRESS</a></li>
<li><a class="reference internal" href="#servicios-resilentes">SERVICIOS RESILENTES</a></li>
<li><a class="reference internal" href="#load-balancing">LOAD BALANCING</a></li>
<li><a class="reference internal" href="#timeout">TIMEOUT</a></li>
<li><a class="reference internal" href="#circuit-breaker">CIRCUIT BREAKER</a></li>
<li><a class="reference internal" href="#pool-ejection">POOL EJECTION</a></li>
<li><a class="reference internal" href="#solucion-final">SOLUCION FINAL</a></li>
<li><a class="reference internal" href="#testing">TESTING</a><ul>
<li><a class="reference internal" href="#testing-caotico">TESTING CAOTICO</a></li>
<li><a class="reference internal" href="#retrasos">RETRASOS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#trazabilidad">TRAZABILIDAD</a><ul>
<li><a class="reference internal" href="#metricas">MÉTRICAS</a></li>
<li><a class="reference internal" href="#kiali">KIALI</a></li>
</ul>
</li>
<li><a class="reference internal" href="#seguridad">SEGURIDAD</a><ul>
<li><a class="reference internal" href="#white-lists">WHITE LISTS</a></li>
<li><a class="reference internal" href="#black-lists">BLACK LISTS</a></li>
<li><a class="reference internal" href="#mutual-tls">MUTUAL TLS</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/main.js"></script>
    <script src="../_static/translations.js"></script>
    </body>
</html>